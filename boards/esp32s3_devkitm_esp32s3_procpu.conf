# ESP32-S3 Specific Configuration
# ESP32-S3 N16R8 Module: 16MB Flash, 8MB PSRAM (OPI)

###############################################################################
# PSRAM (External SPIRAM) Configuration - 8MB OPI PSRAM
###############################################################################
CONFIG_ESP_SPIRAM=y
CONFIG_ESP_SPIRAM_SIZE=8388608
CONFIG_ESP_SPIRAM_HEAP_SIZE=3145728
CONFIG_SPIRAM_MODE_OCT=y
CONFIG_SPIRAM_TYPE_ESPPSRAM64=y
CONFIG_SPIRAM_SPEED_80M=y

# Enable MEMC driver - REQUIRED for OCRE PSRAM_SECTION_ATTR to work
# This allows WAMR heap buffer to be placed in PSRAM instead of internal DRAM
CONFIG_MEMC=y

# Optional: Move read-only data to PSRAM to free internal DRAM
# CONFIG_SPIRAM_RODATA=y

# Skip PSRAM memtest for faster boot (enable for debugging)
CONFIG_ESP_SPIRAM_MEMTEST=n

###############################################################################
# Thread Local Storage - REQUIRED for ESP32-S3 OCRE/WAMR
###############################################################################
# ESP32-S3 has THREADPTR register (XCHAL_HAVE_THREADPTR=1).
# Without TLS enabled, Zephyr doesn't initialize or manage THREADPTR,
# leaving garbage values that cause crashes when WAMR accesses TLS.
CONFIG_THREAD_LOCAL_STORAGE=y

###############################################################################
# Memory Configuration (with PSRAM)
###############################################################################
# Keep internal DRAM heap smaller - use PSRAM for large allocations
CONFIG_HEAP_MEM_POOL_SIZE=24576
CONFIG_MAIN_STACK_SIZE=2560
CONFIG_SYSTEM_WORKQUEUE_STACK_SIZE=1280
# Shell needs larger stack for OCRE/WASM operations
CONFIG_SHELL_STACK_SIZE=5120

# Shared Multi-Heap for PSRAM allocation
CONFIG_SHARED_MULTI_HEAP=y

###############################################################################
# ESP32-S3 WiFi/BT
###############################################################################
CONFIG_WIFI=y
CONFIG_ESP32_WIFI_STA_AUTO_DHCPV4=y

# SPI for display
CONFIG_SPI=y

# Sensor support
CONFIG_I2C=y
CONFIG_SENSOR=y

###############################################################################
# App Manager - Enabled with PSRAM support
###############################################################################
# With 8MB PSRAM, we can now enable App Manager
# OCRE runtime and WASM heaps will use PSRAM
CONFIG_AKIRA_APP_MANAGER=y

###############################################################################
# OCRE Memory Configuration - Using PSRAM for large buffers
###############################################################################
# With CONFIG_MEMC=y and ESP32-S3 PSRAM support in ocre_psram.h,
# the WAMR heap buffer is placed in external SPIRAM (.ext_ram.bss section)
# This allows much larger WAMR heap without consuming internal DRAM
CONFIG_OCRE_WAMR_HEAP_BUFFER_SIZE=1048576

# Container settings
CONFIG_OCRE_CONTAINER_DEFAULT_STACK_SIZE=3072
CONFIG_OCRE_CONTAINER_DEFAULT_HEAP_SIZE=3072

# Limit max containers to save memory
CONFIG_MAX_CONTAINERS=2

###############################################################################
# Logging - Use immediate mode for debugging
###############################################################################
CONFIG_LOG_MODE_IMMEDIATE=y
