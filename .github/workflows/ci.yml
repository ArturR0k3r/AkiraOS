name: Akira CI

on:
  push:
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    
    env:
      ZEPHYR_TOOLCHAIN_VARIANT: zephyr
      ZEPHYR_SDK_INSTALL_DIR: /opt/toolchains/zephyr-sdk-0.16.5

    steps:
      - name: Free Disk Space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          sudo docker system prune -af
          df -h
      
      - name: Start container
        run: |
          docker pull ghcr.io/zephyrproject-rtos/ci:latest
          docker run -d --name zephyr-ci -v $PWD:/workspace -w /workspace --user root ghcr.io/zephyrproject-rtos/ci:latest tail -f /dev/null
      
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          path: akira-os
          submodules: recursive

      - name: Initialize west workspace
        run: |
          docker exec -w /workspace/akira-os zephyr-ci bash -c "west init -l . && west update"

      - name: Setup Zephyr SDK
        run: |
          docker exec -w /workspace/akira-os zephyr-ci bash -c '
            if [ ! -f "$ZEPHYR_SDK_INSTALL_DIR/sdk_version" ]; then
              echo "Zephyr SDK not found, installing...";
              wget -q https://github.com/zephyrproject-rtos/sdk-ng/releases/download/v0.16.5/zephyr-sdk-0.16.5_linux-x86_64.tar.xz;
              tar xf zephyr-sdk-0.16.5_linux-x86_64.tar.xz -C /opt/toolchains;
              cd /opt/toolchains/zephyr-sdk-0.16.5;
              ./setup.sh -t all -h -c;
            else
              echo "Zephyr SDK already installed";
            fi
          '

      - name: Zephyr env
        run: |
          docker exec -w /workspace/akira-os zephyr-ci west zephyr-export

      - name: Install ESP-IDF
        run: |
          docker exec zephyr-ci bash -c '
            apt-get update && apt-get install -y git wget flex bison gperf python3-venv cmake ninja-build ccache libffi-dev libssl-dev dfu-util libusb-1.0-0;
            git clone --depth 1 --branch v5.1.2 https://github.com/espressif/esp-idf.git /opt/esp-idf;
            cd /opt/esp-idf;
            pip3 install -r requirements.txt;
            ./install.sh --enable-ci esp32,esp32s3,esp32c3
          '

      - name: Build ESP32-S3_devkitm
        run: |
          docker exec -w /workspace/akira-os zephyr-ci bash -c '. /opt/esp-idf/export.sh && west build -b esp32s3_devkitm_esp32s3_procpu . --pristine'

      - name: Build native_sim
        run: |
          docker exec -w /workspace/akira-os zephyr-ci west build -b native_sim . --pristine

      - name: Build b_u585i_iot02a
        run: |
          docker exec -w /workspace/akira-os zephyr-ci west build -b b_u585i_iot02a . --pristine
      
      - name: Cleanup container
        if: always()
        run: |
          docker stop zephyr-ci || true
          docker rm zephyr-ci || true