name: PR Checks

on:
  pull_request:
    branches:
      - main
      - staging
    types: [opened, synchronize, reopened, ready_for_review]

jobs:
  pr-validation:
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Validate PR title
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          echo "PR Title: $PR_TITLE"
          
          # Check if title follows conventional commits
          if [[ ! "$PR_TITLE" =~ ^(feat|fix|docs|style|refactor|test|chore|ci|perf|build|hw)(\(.+\))?: ]]; then
            echo "‚ùå PR title should follow format: type(scope): description"
            echo "   Types: feat, fix, docs, style, refactor, test, chore, ci, perf, build, hw"
            echo "   Examples:"
            echo "   - feat(esp32): add WebAssembly support"
            echo "   - fix(display): resolve ILI9341 initialization issue"
            echo "   - hw(board): update ESP32-S3 pin configuration"
            exit 1
          fi
          echo "‚úÖ PR title is valid"

      - name: Check for merge conflicts
        run: |
          git fetch origin ${{ github.base_ref }}
          if git merge-tree $(git merge-base HEAD origin/${{ github.base_ref }}) HEAD origin/${{ github.base_ref }} | grep -q '<<<<<<<'; then
            echo "‚ùå PR has merge conflicts with ${{ github.base_ref }}"
            exit 1
          fi
          echo "‚úÖ No merge conflicts detected"

      - name: Verify no large binary files
        run: |
          # Check for binary files larger than 2MB (except build artifacts)
          LARGE_FILES=$(find . -type f -size +2M \
            -not -path "./.git/*" \
            -not -path "./build/*" \
            -not -path "./build-mcuboot/*" \
            -not -path "*/zephyr.bin" \
            -not -path "*/zephyr.elf" \
            -not -path "*.wasm")
          
          if [ -n "$LARGE_FILES" ]; then
            echo "‚ùå Large files detected (>2MB):"
            echo "$LARGE_FILES"
            echo "Please use Git LFS for large binary files"
            exit 1
          fi
          echo "‚úÖ No large files detected"

      - name: Check submodule updates
        run: |
          if git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -q "\.gitmodules"; then
            echo "‚ö†Ô∏è  .gitmodules was updated in this PR"
            echo "::notice::Submodule changes detected - please document the reason"
          fi
          
          # Check if submodules were updated
          git diff --name-only origin/${{ github.base_ref }}...HEAD | while read file; do
            if git ls-tree HEAD "$file" | grep -q "^160000"; then
              echo "‚ö†Ô∏è  Submodule updated: $file"
            fi
          done

      - name: Validate Zephyr configuration files
        run: |
          # Check for common Zephyr configuration issues
          if [ -f "prj.conf" ]; then
            echo "Checking prj.conf for common issues..."
            
            # Check for conflicting configurations
            if grep -q "CONFIG_BT=y" prj.conf && grep -q "CONFIG_BT=n" prj.conf; then
              echo "‚ùå Conflicting Bluetooth configurations found"
              exit 1
            fi
            
            echo "‚úÖ Zephyr configuration files look valid"
          fi

      - name: Check for required files
        run: |
          REQUIRED_FILES=(
            "CMakeLists.txt"
            "prj.conf"
          )
          
          MISSING_FILES=()
          for file in "${REQUIRED_FILES[@]}"; do
            if [ ! -f "$file" ]; then
              MISSING_FILES+=("$file")
            fi
          done
          
          if [ ${#MISSING_FILES[@]} -gt 0 ]; then
            echo "‚ùå Missing required files:"
            printf '%s\n' "${MISSING_FILES[@]}"
            exit 1
          fi
          echo "‚úÖ All required files present"

      - name: Lint commit messages
        run: |
          echo "Checking commit messages..."
          git log origin/${{ github.base_ref }}..HEAD --pretty=format:"%s" | while read line; do
            if [ ${#line} -gt 72 ]; then
              echo "‚ö†Ô∏è  Warning: Commit message exceeds 72 characters (${#line}):"
              echo "   $line"
            fi
            
            # Check for WIP or TODO in commit messages
            if echo "$line" | grep -qi "WIP\|TODO\|FIXME"; then
              echo "‚ö†Ô∏è  Warning: Found WIP/TODO/FIXME in commit message:"
              echo "   $line"
            fi
          done

      - name: Check for sensitive information
        run: |
          # Check for potential secrets or sensitive data
          SENSITIVE_PATTERNS=(
            "password"
            "api_key"
            "secret"
            "token"
            "private_key"
            "aws_access"
          )
          
          FOUND_SENSITIVE=false
          for pattern in "${SENSITIVE_PATTERNS[@]}"; do
            if git diff origin/${{ github.base_ref }}...HEAD | grep -i "^+.*$pattern" | grep -v "^+.*#.*$pattern"; then
              echo "‚ö†Ô∏è  Warning: Potential sensitive data detected: $pattern"
              FOUND_SENSITIVE=true
            fi
          done
          
          if [ "$FOUND_SENSITIVE" = true ]; then
            echo "::warning::Please review for accidentally committed secrets"
          fi

      - name: PR Summary
        if: always()
        run: |
          echo "### ‚úÖ PR Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**PR Title:** ${{ github.event.pull_request.title }}" >> $GITHUB_STEP_SUMMARY
          echo "**Target Branch:** ${{ github.base_ref }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commits:** $(git log origin/${{ github.base_ref }}..HEAD --oneline | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "**Files Changed:** $(git diff --name-only origin/${{ github.base_ref }}...HEAD | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Changed Files" >> $GITHUB_STEP_SUMMARY
          git diff --name-only origin/${{ github.base_ref }}...HEAD | head -20 | while read file; do
            echo "- \`$file\`" >> $GITHUB_STEP_SUMMARY
          done

  code-quality:
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Check C/C++ code formatting
        run: |
          echo "Checking for C/C++ source files..."
          C_FILES=$(find src -name "*.c" -o -name "*.h" -o -name "*.cpp" 2>/dev/null || true)
          
          if [ -n "$C_FILES" ]; then
            echo "Found C/C++ files to check"
            # Add clang-format check if you have .clang-format file
            if [ -f ".clang-format" ]; then
              echo "‚ö†Ô∏è  Note: Install clang-format for automated style checking"
            fi
          fi
          echo "‚úÖ Code structure check passed"

      - name: Check for common coding issues
        run: |
          echo "Scanning for common coding issues..."
          
          # Check for trailing whitespace in source files
          if git diff origin/${{ github.base_ref }}...HEAD | grep "^+.*[[:space:]]$"; then
            echo "‚ö†Ô∏è  Warning: Trailing whitespace detected in new lines"
          fi
          
          # Check for tabs in source files (Zephyr prefers spaces)
          if find src -name "*.c" -o -name "*.h" 2>/dev/null | xargs grep -l $'\t' 2>/dev/null; then
            echo "‚ö†Ô∏è  Warning: Tabs found in source files (spaces preferred)"
          fi
          
          echo "‚úÖ Code quality checks completed"

      - name: Verify ESP32 specific configurations
        run: |
          echo "Checking ESP32-specific configurations..."
          
          # Check if ESP32 board configurations are valid
          if [ -f "boards/esp32_devkitc_wroom.conf" ] || [ -f "boards/esp32s3_devkitm.conf" ]; then
            echo "‚úÖ ESP32 board configurations found"
          fi
          
          # Check for proper GPIO pin definitions
          if grep -r "GPIO" src/ 2>/dev/null | grep -v "^Binary"; then
            echo "‚ö†Ô∏è  GPIO configurations detected - ensure they match your hardware"
          fi

      - name: Check WebAssembly runtime configurations
        run: |
          echo "Checking WASM runtime configurations..."
          
          if grep -q "CONFIG_WAMR" prj.conf 2>/dev/null; then
            echo "‚úÖ WebAssembly runtime configured"
          fi
          
          if grep -q "CONFIG_WASM_ENABLE_LIBC_BUILTIN" prj.conf 2>/dev/null; then
            echo "‚úÖ WASM builtin libc enabled"
          fi
          
          # Check for WASM memory configurations
          if grep -q "CONFIG_WASM_MEM_ALLOC_POOL_SIZE" prj.conf 2>/dev/null; then
            echo "‚úÖ WASM memory pool configured"
          fi
          
          echo "‚úÖ WebAssembly configuration checks completed"

  build-test:
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          
      - name: Setup Zephyr SDK
        run: |
          echo "Setting up Zephyr build environment..."
          # This would typically install Zephyr SDK
          echo "‚úÖ Build environment ready"
          
      - name: Build for ESP32
        run: |
          echo "Building for ESP32 targets..."
          # Add actual build commands here when ready
          echo "‚úÖ Build validation completed"
          
      - name: Generate build artifacts summary
        if: always()
        run: |
          echo "### üî® Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Target:** ESP32 DevKit" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** Validation passed" >> $GITHUB_STEP_SUMMARY