name: Build

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main, System-implementation-and-core-integrations ]

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        board:
          - esp32s3_devkitm/esp32s3/procpu
          - esp32_devkitc/esp32/procpu
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        path: akira-os
    
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y --no-install-recommends \
          git cmake ninja-build gperf ccache dfu-util \
          device-tree-compiler wget xz-utils file make \
          gcc gcc-multilib g++-multilib libsdl2-dev \
          python3-dev python3-pip python3-setuptools \
          python3-wheel
    
    - name: Install Python dependencies
      run: |
        pip3 install --user -U west pyelftools intelhex cbor2 cryptography PyYAML
        echo "$HOME/.local/bin" >> $GITHUB_PATH

    - name: Cache Zephyr SDK
      id: cache-zephyr-sdk
      uses: actions/cache@v4
      with:
        path: ~/zephyr-sdk-0.16.8
        key: zephyr-sdk-0.16.8-${{ runner.os }}
    
    - name: Install Zephyr SDK
      if: steps.cache-zephyr-sdk.outputs.cache-hit != 'true'
      run: |
        cd ~
        wget -q https://github.com/zephyrproject-rtos/sdk-ng/releases/download/v0.16.8/zephyr-sdk-0.16.8_linux-x86_64_minimal.tar.xz
        tar xf zephyr-sdk-0.16.8_linux-x86_64_minimal.tar.xz
        cd zephyr-sdk-0.16.8
        ./setup.sh -t xtensa-espressif_esp32_zephyr-elf -t xtensa-espressif_esp32s3_zephyr-elf -h -c
    
    - name: Initialize West workspace
      run: |
        west init -l akira-os
        west update
        west blobs fetch hal_espressif
      env:
        ZEPHYR_BASE: ${{ github.workspace }}/zephyr
    
    - name: Export Zephyr environment
      run: |
        echo "ZEPHYR_TOOLCHAIN_VARIANT=zephyr" >> $GITHUB_ENV
        echo "ZEPHYR_SDK_INSTALL_DIR=$HOME/zephyr-sdk-0.16.8" >> $GITHUB_ENV
    
    - name: Build AkiraOS application for ${{ matrix.board }}
      run: |
        west build --pristine -b ${{ matrix.board }} \
          akira-os -d build \
          -- -DMODULE_EXT_ROOT=${{ github.workspace }}/akira-os
    
    - name: Generate build info
      run: |
        echo "Board: ${{ matrix.board }}" > build/build-info.txt
        echo "Commit: ${{ github.sha }}" >> build/build-info.txt
        echo "Branch: ${{ github.ref_name }}" >> build/build-info.txt
        echo "Build Date: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> build/build-info.txt
        ls -lh build/zephyr/zephyr.* >> build/build-info.txt || true
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: akira-os-${{ matrix.board }}-${{ github.sha }}
        path: |
          build/zephyr/zephyr.bin
          build/zephyr/zephyr.elf
          build/zephyr/zephyr.hex
          build/build-info.txt
        retention-days: 30